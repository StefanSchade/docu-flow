= Developer Guide

== Getting Started 

=== prerequisites 

* Windows host machine (otherwise look here <<_developing_on_non_windows_systems>>)
* GIT installed
* Docker installed (either Docker Desktop or WSL2)

=== step by step

. *clone the repo:* typicaly you would create a GitHub fork and clone this to your machine 
. *start dev environment:* run the scripts to build and run the dev container (`./scripts/*.cmd')
. *dev tasks:* use the  bash scripts (`./scripts/*.sh`) for the typical task
  .. running the app
  .. running the tests
  .. perform linting
  .. running the pipeline locally prior to commit

=== developing on non Windows systems

The Docker based setup abstracts away most aspects of the host system. The only real dependence on windows are the start scripts (`*.cmd` files in the folder `scripts/`). These scripts just provide a convenient way to build and run the docker images and should be easy to port to a diffrent environemnt.

== development in a container

I like developing in docker containers and here I want to present some of the benfits I see and describe my setup.

=== motivation and advantages

* *access to a linux system from a Windows desktop* + 
Windows is a comon desktop setup due to a low price tag (esp. compared to MacOS systems) and the ubiquitous presence at the workplace. For development I would however prefer a Linux system - a Docker setup makes this possible. There are several reasons I prefer a Linux environment for development

  ** in most cases Linux is a *better representation of the target environment* than Windows
      *** web applications
      *** anything deployed to the cloud will likely not only run on windows but in a container

  ** personally, I am *more familar with Unix tools* than with Windows
      *** scripting for me is easier in `bash` compared to `powershell` or `cmd`
      *** I am more familar with Unix system tools than with windows

  ** *access to libraries* and programming environments
      *** better availiability of libraries (e.g. https://pyenchant.github.io/pyenchant/install.html[pyenchant])
      *** in case one ventures into aspects of system programming (e.g. networking) a Unix host system is preferable
      *** software builds can be exchanged since everything is consistently Linux / Docker

* dependencies on the *host system abstracted away* +
The main feature of container technology is to abstract away the host environment and provide a clear interface. The ease of deployment is not only an advantage in production.

  ** a new machine can be easily setup for development by installing Docker, there is no need to setup dev dependencies like additional tools
  ** a new developer can build and run the applciation within minutes
  ** as each project is isolated in its own container there are no issues with conflicting libraries or tools
  ** maintaining the developmet environment becomes easier

* the isolated environment in a container makes development easier

  ** the paths inside the container are known
  ** all tools are present, their location and version is asured

=== layers

===== at hints

* view pending at jobs: `atq`
* view details of a specific job: `at -c <job_id>`
* remove a pending job: `atrm <job_id>`
* look at error logs - various approaches depending on system
  ** `grep -i "at" /var/log/syslog`
  ** `journalctl -u atd11`

=== volume mounts

the 

=== design decisions

==== Why is there 

==== Why is the python virtual environment (`/venv/`) located in a docker volume?

The 2 alternatives would have been to put it inside
* the container file system
* normal mount point

The first option would imply that the `requirement.txt` and `requirement-dev.txt` files are copied to the container. This would contradict the idea t

== Developer Use Cases

=== Starting the Dev Container 

Scripts facilitate container startup. They reside in `/scripts`.

==== MacOS and Linux

Not implemented currently

==== Windows

Relevant scripts are:

* `dev_container_env.cmd` reduces redundancy and keeps the configuration consistent across the other scripts.
* `dev_container_build.cmd` checks imestamps to decide whether to rebuild the Docker image - also creates a Docker volume if this does not exist already
* `dev_container_run.cmd`
* `dev_container_build_and_run.cmd`

Use Cases:

* Build and Run Normally: `dev_container_build_and_run.cmd`
* Force Rebuild and Run: `dev_container_build_and_run.cmd --force-rebuild` 
* Run a Specific Command in the Container: `dev_container_build_and_run.cmd python script.py`
* Force Rebuild and Run a Specific Command: `dev_container_build_and_run.cmd --force-rebuild python script.py`



==== Starting the container from Windows

To start the container from Windows, you can use the provided PowerShell scripts. Below are instructions for running the scripts from both PowerShell and the Command Prompt (CMD), including how to set the script execution policy if necessary.

===== Running from Windows PowerShell

To run the scripts from PowerShell:

. *Open PowerShell:* Open a PowerShell window.

. *Navigate to the scripts directory:* Use the `cd` command to navigate to the directory where your scripts are located.

. *Set the execution policy (if necessary):* If you have not previously allowed PowerShell to run scripts, you may need to set the execution policy. You can set it to `RemoteSigned` for the current user:

[source, powershell]
----
Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned
----
_Note: You do not need to run PowerShell as Administrator when setting the execution policy for the current user._

[start=4]
. *Run the build and run script:*

  ** Build and run normally:

      .\dev_container_build_and_run.ps1

   ** Force rebuild and run:

      .\dev_container_build_and_run.ps1 -ForceRebuild

   ** Run a specific command in the container:

      .\dev_container_build_and_run.ps1 -RunCmd "python script.py"

   ** Force rebuild and run a specific command:

      .\dev_container_build_and_run.ps1 -ForceRebuild -RunCmd "python script.py"

===== Running from Command Prompt (CMD)

To run the scripts from the Windows Command Prompt (CMD):

. *Open Command Prompt:* Open a Command Prompt window.

. *Navigate to the scripts directory:* Use the `cd` command to navigate to the directory where your scripts are located.

. *Run the PowerShell scripts using `powershell -File`:*

   ** Build and run normally:

      powershell -File dev_container_build_and_run.ps1

   ** Force rebuild and run:

      powershell -File dev_container_build_and_run.ps1 -ForceRebuild

   ** Run a specific command in the container:

      powershell -File dev_container_build_and_run.ps1 -RunCmd "python script.py"

   ** Force rebuild and run a specific command:

      powershell -File dev_container_build_and_run.ps1 -ForceRebuild -RunCmd "python script.py"

===== Script Execution Policy

If you encounter an error related to script execution policies when running the scripts, you may need to adjust your PowerShell execution policy to allow scripts to run.

To set the execution policy to allow running local scripts:

Open PowerShell: Open a PowerShell window. You do not need to run it as Administrator when setting the execution policy for the current user.

Set the execution policy:

[source, powershell]
----
Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned
----
This command allows you to run scripts you've created locally while still protecting against running scripts from untrusted sources.

Confirm the change: You may be prompted to confirm the change. Type Y and press Enter.

Note: Be cautious when changing the execution policy, and only run scripts from trusted sources.

===== Additional Notes

Ensure Docker Desktop is running: Before running the scripts, make sure that Docker Desktop is installed and running on your Windows machine.

Script Parameters: The dev_container_build_and_run.ps1 script accepts the following parameters:

-ForceRebuild: Forces the Docker image to be rebuilt, even if it is up-to-date.

-RunCmd: Specifies a command to run inside the container instead of starting an interactive shell.

Docker Socket Mounting: The scripts mount the Docker socket inside the container to allow Docker commands to be run from within the container. On Windows, the Docker socket is typically mounted using:

[source, powershell]
----
-v "//var/run/docker.sock":"/var/run/docker.sock"
----
If you encounter issues, you can adjust the mount to use the named pipe:

[source, powershell]
----
--mount type=npipe,source=\\.\pipe\docker_engine,target=\\.\pipe\docker_engine
----
Adjusting Scripts if Necessary: If you need to adjust the scripts or encounter any issues, you can edit them using a text editor. Ensure that the paths and variables are correctly set for your environment.

Script Execution Policy Scope: Changing the execution policy for the current user (CurrentUser scope) does not require administrative privileges and only affects your user account.

Security Considerations: Always be cautious when running scripts, especially those obtained from external sources. Review the contents of scripts before executing them to ensure they are safe.

Further Assistance: If you need additional help or encounter issues, consider consulting the Docker or PowerShell documentation, or reach out to your development team for support.




